#!/bin/sh

upset() {
  # Use the provided upstream if available, otherwise get the current one.
  UPSTREAM=${1:-$(git rev-parse --abbrev-ref @{u} 2>/dev/null)}

  # check if the upstream branch is configured
  if [ -z "$UPSTREAM" ]; then
    echo "no upstream branch is configured for the current branch and none was provided" >&2
    return 1
  fi

  REMOTE=$(echo "$UPSTREAM" | cut -d'/' -f1)
  BRANCH=$(echo "$UPSTREAM" | cut -d'/' -f2-)

  git fetch "$REMOTE" "$BRANCH"
  git reset --hard FETCH_HEAD
}

feature() {
  BRANCH=pull/$(git rev-parse HEAD)

  git branch $BRANCH
  git push origin $BRANCH:$BRANCH
}

temp() {
  # generate a random hash
  HASH=$(date | sha256sum | awk '{print substr($1, 1, 40)}')

  git checkout -b "temp/$HASH"
}

case "$1" in
  rebase|checkout|switch|push)
    git $@ -f
    ;;
  reset)
    git $@ --hard
    ;;
  clean)
    git clean -dfx
    ;;
  upset)
    upset "$2"
    ;;
  feature)
    feature
    ;;
  temp)
    temp
    ;;
  *)
    git $@
    ;;
esac
