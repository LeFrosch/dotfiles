#!/bin/bash

upset() {
  # use the provided upstream if available, otherwise get the current one.
  if [ -n "$1" ]; then
    UPSTREAM="$1"
  else
    UPSTREAM=$(git rev-parse --abbrev-ref @{u} 2>/dev/null)
  fi

  # check if the upstream branch is configured
  if [ -z "$UPSTREAM" ]; then
    echo "no upstream branch is configured for the current branch and none was provided" >&2
    return 1
  fi

  REMOTE=$(echo "$UPSTREAM" | cut -d'/' -f1)
  BRANCH=$(echo "$UPSTREAM" | cut -d'/' -f2-)

  git fetch "$REMOTE" "$BRANCH"
  git reset --hard FETCH_HEAD
}

feature() {
  BRANCH=pull/$(git rev-parse HEAD)

  git branch $BRANCH
  git push origin $BRANCH:$BRANCH
}

temp() {
  # generate a random hash
  HASH=$(date | sha256sum | awk '{print substr($1, 1, 40)}')

  git checkout -b "temp/$HASH"
}

claude() {
  # henerate a random hash using the same method as temp()
  HASH=$(date | sha256sum | awk '{print substr($1, 1, 40)}')
  BRANCH="temp/$HASH"

  # create a temporary directory
  TEMP_DIR=$(mktemp -d -t "fit-${HASH}") || {
    echo "Failed to create temporary directory" >&2
    return 1
  }

  # create a worktree with a new branch 
  git worktree add -b "$BRANCH" "$TEMP_DIR" || {
    rm -rf "$TEMP_DIR"
    echo "Failed to create worktree at: $TEMP_DIR" >&2
    return 1
  }

  # execute claude in the temp directory
  env -C "$TEMP_DIR" claude || {
    git worktree remove "$TEMP_DIR" 2>/dev/null
    git branch -D "$BRANCH" 2>/dev/null
    rm -rf "$TEMP_DIR"
    echo "Failed to start claude" >&2
    return 1
  }
}

case "$1" in
  rebase|checkout|switch|push)
    git $@ -f
    ;;
  reset)
    git $@ --hard
    ;;
  clean)
    git clean -dfx
    ;;
  claude)
    claude
    ;;
  upset)
    upset "$2"
    ;;
  feature)
    feature
    ;;
  temp)
    temp
    ;;
  *)
    git $@
    ;;
esac
